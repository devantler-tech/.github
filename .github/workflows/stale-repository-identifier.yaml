name: ðŸ§¹ Stale repository identifier

on:
  workflow_dispatch:
  schedule:
    - cron: "3 2 1 * *"

permissions:
  contents: read
  issues: write

jobs:
  stale-repository-identifier:
    name: ðŸ§¹ Stale repository identifier
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”‘ Get GitHub App Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: ðŸ“‘ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: true

      - name: ðŸ§¹ Identify stale repositories
        uses: github/stale-repos@95959ca360207f1c95620a3e8fc55bdab31f2223 # v9.0.0
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          EXEMPT_TOPICS: "keep,template"
          INACTIVE_DAYS: 365
          ADDITIONAL_METRICS: "release,pr"
          ORGANIZATION: devantler-tech

      - name: ðŸ”Ž Check for the stale report issue
        run: |
          ISSUE_NUMBER=$(gh search issues "Stale-repository-report" --match title --json number --jq ".[0].number")
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_ENV"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“„ Create or update stale report issue
        uses: peter-evans/create-issue-from-file@fca9117c27cdc29c6c4db3b86c48e4115a786710 # v6.0.0
        with:
          issue-number: ${{ env.issue_number }}
          title: ðŸ“„ Stale repository report
          content-filepath: ./stale_repos.md
          assignees: devantler
          token: ${{ secrets.GITHUB_TOKEN }}
